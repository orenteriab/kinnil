<!DOCTYPE html>

<html lang="en">
    <head>
        <title>Cedar - Client Query</title>
        <link rel="stylesheet" href="/assets/css/bootstrap.css" rel="stylesheet">
    </head>

    <body>
        <div style="margin: auto auto; width: 800px;">
            <div class="container-fluid">
                <div class="row" style="height: 100px; text-align:center;">
                    <div class="col-md-10">
                        <h1>ON SITE PROPPANT MANAGEMENT</h1>
                    </div>
                    <div class="col-md-2">
                        <img src="/assets/img/logo.png" style="width:100px;" />
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-2">
                        <span>Customer:</span>
                        <br />
                        <input id="tx_customer" type="text" disabled="disabled" value="Halliburton" />
                        <br />
                        <span>Location:</span>
                        <br />
                        <select id="sl_location">
                            <option value="-1">Select a location</option>
                            <% locations.forEach((location) => { %>
                            <option value="<%= location.id %>"><%= location.name %></option>
                            <% }) %>
                        </select>
                        <button id="btn_load_location">GO!</button>
                    </div>
                    <div class="col-md-2">&nbsp;</div>
                    <div class="col-md-2">&nbsp;</div>
                    <div class="col-md-2">
                        <span>Date: </span>
                        <br />
                        <span>Last date received: </span>
                    </div>
                    <div class="col-md-2">
                        <span id="sp_date"></span>
                        <br />
                        <span id="sp_last_date">Select a location first.</span>
                    </div>
                    <div class="col-md-2">
                        <button id="btn_reload" class="btn btn-primary" style="width: 100%;">Refresh</button>
                    </div>
                </div>
                <div id="dv_scales_data" class="row" style="text-align:center;">
                    <div class="col-md-2">
                        <h2>Silo 1</h2>
                    </div>

                    <div class="col-md-2">
                        <h2>Silo 2</h2>
                    </div>

                    <div class="col-md-2">
                        <h2>Silo 3</h2>
                    </div>

                    <div class="col-md-2">
                        <h2>Silo 4</h2>
                    </div>

                    <div class="col-md-2">
                        <h2>Silo 5</h2>
                    </div>

                    <div class="col-md-2">
                        <h2>Silo 6</h2>
                    </div>

                    <div class="col-md-2">
                        <h3>
                            <span id="sp_silo_percentage_01"></span><span>%</span>
                        </h3>
                    </div>

                    <div class="col-md-2">
                        <h3>
                            <span id="sp_silo_percentage_02"></span><span>%</span>
                        </h3>
                    </div>

                    <div class="col-md-2">
                        <h3>
                            <span id="sp_silo_percentage_03"></span><span>%</span>
                        </h3>
                    </div>

                    <div class="col-md-2">
                        <h3>
                            <span id="sp_silo_percentage_04"></span><span>%</span>
                        </h3>
                    </div>

                    <div class="col-md-2">
                        <h3>
                            <span id="sp_silo_percentage_05"></span><span>%</span>
                        </h3>
                    </div>

                    <div class="col-md-2">
                        <h3>
                            <span id="sp_silo_percentage_06"></span><span>%</span>
                        </h3>
                    </div>

                    <div class="col-md-2" style="height: 200px; display:block;">
                        <div style="position:relative; height: 100%; width: 80%; margin: auto auto; border: 2px solid black;">
                            <div id="dv_silo_percentage_01" style="position:absolute; bottom: 0px; width: 100%; margin-left: auto; margin-right:auto; height: 0px; background-color: red;"></div>
                        </div>
                        
                    </div>

                    <div class="col-md-2" style="height: 200px; display:block;">
                        <div style="position:relative; height: 100%; width: 80%; margin: auto auto; border: 2px solid black;">
                            <div id="dv_silo_percentage_02" style="position:absolute; bottom: 0px; width: 100%; margin-left: auto; margin-right:auto; height: 0px; background-color: green;"></div>
                        </div>
                    </div>

                    <div class="col-md-2" style="height: 200px; display:block;">
                        <div style="position:relative; height: 100%; width: 80%; margin: auto auto; border: 2px solid black;">
                            <div id="dv_silo_percentage_03" style="position:absolute; bottom: 0px; width: 100%; margin-left: auto; margin-right:auto; height: 0px; background-color: orange;"></div>
                        </div>
                    </div>

                    <div class="col-md-2" style="height: 200px; display:block;">
                        <div style="position:relative; height: 100%; width: 80%; margin: auto auto; border: 2px solid black;">
                            <div id="dv_silo_percentage_04" style="position:absolute; bottom: 0px; width: 100%; margin-left: auto; margin-right:auto; height: 0px; background-color: orange;"></div>
                        </div>
                    </div>

                    <div class="col-md-2" style="height: 200px; display:block;">
                        <div style="position:relative; height: 100%; width: 80%; margin: auto auto; border: 2px solid black;">
                            <div id="dv_silo_percentage_05" style="position:absolute; bottom: 0px; width: 100%; margin-left: auto; margin-right:auto; height: 0px; background-color: green;"></div>
                        </div>
                    </div>

                    <div class="col-md-2" style="height: 200px; display:block;">
                        <div style="position:relative; height: 100%; width: 80%; margin: auto auto; border: 2px solid black;">
                            <div id="dv_silo_percentage_06" style="position:absolute; bottom: 0px; width: 100%; margin-left: auto; margin-right:auto; height: 0px; background-color: red;"></div>
                        </div>
                    </div>
                    <div class="col-md-12" style="height: 10px; display:block;"></div>
                    <div class="col-md-12" style="height: 100px; display:block; border: 2px solid black; text-align: left;">
                        <h2>Goals - <span class="sp_goals_location_name"></span></h2>
                        <table style="width: 50%">
                            <tbody id="dv_goals_per_sand"></tbody>
                        </table>
                    </div>
                    <div class="col-md-12" style="height: 10px; display:block;"></div>
                    <div class="col-md-12" style="height: 100px; display:block; border: 2px solid black; text-align: left;">
                        <h2>To this day:</h2>
                        <table style="width: 50%">
                            <tbody id="dv_goals_to_this_day"></tbody>
                        </table>
                    </div>
                    <div class="col-md-12" style="height: 10px; display:block;"></div>
                    <div class="col-md-12" style="height: 100px; display:block; border: 2px solid black; text-align: left;">
                        <h2>GreenCoreWell - <span class="sp_goals_location_name"></span></h2>
                        <table style="width: 100%">
                            <tbody id="dv_goals_green_core_well"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <script src="/assets/js/jquery.js" type="text/javascript"></script>
        <script type="text/javascript">
            (function(APP){
                APP.SERVICES = APP.SERVICES || {};

                APP.SERVICES.FETCH_GOALS_DATA = APP.SERVICES.FETCH_GOALS_DATA || function(locationId){
                    $.ajax({
                        url: '/api/administrative/location/'+ locationId +'/goals-data',
                        success: function(goalsData){
                            $('#dv_goals_green_core_well,#dv_goals_to_this_day,#dv_goals_per_sand').html('');

                            for(var i = 0; i < goalsData.length; i++){
                                var goal = goalsData[i];

                                var productNameLabel = $('<span></span>').text(goal.name);
                                var productNameColumn = $('<td></td>').append(productNameLabel);
                                var productGoalLbsLabel = $('<span></span>').text(parseFloat(goal.lbs_goal).toFixed(2));
                                var productGoalLbsColumn = $('<td></td>').append(productGoalLbsLabel);

                                var productRow = $('<tr></tr>');
                                productRow.append(productNameColumn);
                                productRow.append(productGoalLbsColumn);

                                $('#dv_goals_per_sand').append(productRow);

                                var toThisDayWeightLabel = $('<span></span>').text(goal.lbs_current);
                                var toThisDayWeightColumn = $('<td></td>').append(toThisDayWeightLabel);
                                var toThisDayProductDeliveredLabel = $('<span></span>').text(goal.name + ' has been delivered.');
                                var toThisDayProductDeliveredColumn = $('<td></td>').append(toThisDayProductDeliveredLabel);

                                var deliveredRow = $('<tr></tr>');
                                deliveredRow.append(toThisDayWeightColumn);
                                deliveredRow.append(toThisDayProductDeliveredColumn);

                                $('#dv_goals_to_this_day').append(deliveredRow);

                                var greenCoreWeightLabel = $('<span></span>').text(parseInt(goal.loads_goal));
                                var greenCoreWeightColumn = $('<td></td>')
                                    .append(greenCoreWeightLabel)
                                    .css('width', '33%');
                                
                                var currentLoads = parseInt(goal.lads_current);
                                var loadPercentage = parseFloat((loadPercentage / currentLoads) * 100);
                                var remainingLoads = parseInt(goal.loads_goal) - currentLoads;
                                var percentageDiv = $('<div></div>')
                                    .css('width', loadPercentage.toFixed(2) + '%')
                                    .css('background-color', 'green')
                                    .css('height', '100%');
                                
                                var greenCorePercentage = $('<td></td>')
                                    .append(percentageDiv)
                                    .css('width', '66%')
                                    .css('border', '2px solid black');

                                var greenCoreRemainingLabel = $('<span></span>').text(String(remainingLoads) + ' loads to goal.');
                                var greenCoreRemainingColumn = $('<td></td>')
                                    .append(greenCoreRemainingLabel)
                                    .css('width', '33%');
                                
                                var greenCoreRow = $('<tr></tr>')
                                    .append(greenCoreWeightColumn)
                                    .append(greenCorePercentage)
                                    .append(greenCoreRemainingColumn);
                                
                            }

                            APP.UI.EVENTS.SP_LAST_DATE();
                        },
                        error: function(){
                            alert('There was an error when pulling scales data. Reloading page.');
                            APP.location.reload();
                        }
                    });
                };

                APP.SERVICES.FETCH_SCALES_DATA = APP.SERVICES.FETCH_SCALES_DATA || function(locationId){
                    $.ajax({
                        url: '/api/administrative/location/'+ locationId +'/scales-data',
                        success: function(scalesData){
                            $('#sp_silo_percentage_01').text(parseFloat(scalesData[0].porcent1).toFixed(2));
                            $('#sp_silo_percentage_02').text(parseFloat(scalesData[0].porcent2).toFixed(2));
                            $('#sp_silo_percentage_03').text(parseFloat(scalesData[0].porcent3).toFixed(2));
                            $('#sp_silo_percentage_04').text(parseFloat(scalesData[0].porcent4).toFixed(2));
                            $('#sp_silo_percentage_05').text(parseFloat(scalesData[0].porcent5).toFixed(2));
                            $('#sp_silo_percentage_06').text(parseFloat(scalesData[0].porcent6).toFixed(2));

                            $('#dv_silo_percentage_01').css('height', $('#sp_silo_percentage_01').text() + '%');
                            $('#dv_silo_percentage_02').css('height', $('#sp_silo_percentage_02').text() + '%');
                            $('#dv_silo_percentage_03').css('height', $('#sp_silo_percentage_03').text() + '%');
                            $('#dv_silo_percentage_04').css('height', $('#sp_silo_percentage_04').text() + '%');
                            $('#dv_silo_percentage_05').css('height', $('#sp_silo_percentage_05').text() + '%');
                            $('#dv_silo_percentage_06').css('height', $('#sp_silo_percentage_06').text() + '%');
                            
                            APP.SERVICES.FETCH_GOALS_DATA();
                        },
                        error: function(){
                            alert('There was an error when pulling scales data. Reloading page.');
                            APP.location.reload();
                        }
                    });
                };

                APP.UI = APP.UI || {};
                APP.UI.EVENTS = APP.UI.EVENTS|| {};
                APP.UI.EVENTS.BTN_RELOAD = APP.UI.EVENTS.BTN_RELOAD || function(){
                    $('#btn_reload').on('click', function(){
                        APP.location.reload();
                    });
                };

                APP.UI.EVENTS.SP_DATE = APP.UI.EVENTS.SP_DATE || function(){
                    var currentDate = new Date();
                    var month = currentDate.getMonth() + 1;
                    var day = currentDate.getDate();
                    var year = currentDate.getFullYear();

                    var sMonth = (month < 10 ? "0" : "") + String(month) ;
                    var sDay = (day < 10 ? "0" : "") + String(day) ;
                    var sYear = String(year);

                    $('#sp_date').text(sMonth + '/' + sDay + '/' + sYear);
                };

                APP.UI.EVENTS.SP_LAST_DATE = APP.UI.EVENTS.SP_LAST_DATE || function(){
                    var currentDate = new Date();
                    var month = currentDate.getMonth() + 1;
                    var day = currentDate.getDate();
                    var year = currentDate.getFullYear();
                    var hours = currentDate.getHours();
                    var minutes = currentDate.getMinutes();

                    var sMonth = (month < 10 ? "0" : "") + String(month) ;
                    var sDay = (day < 10 ? "0" : "") + String(day) ;
                    var sYear = String(year);
                    var sHours = (hours < 10 ? "0" : "") + String(hours);
                    var sMinutes = (minutes < 10 ? "0" : "") + String(minutes);

                    $('#sp_last_date').text(sMonth + '/' + sDay + '/' + sYear + ' ' + sHours + ':' + sMinutes);
                };


                APP.UI.EVENTS.SL_LOCATION = APP.UI.EVENTS.SL_LOCATION || function(){
                    $('#sl_location').on('change', function(){
                        if($(this).val() !== '-1'){
                            APP.SERVICES.FETCH_SCALES_DATA($(this).val());
                            $('.sp_goals_location_name').text($('#sl_location option:selected').text());
                        }
                    });
                };

                APP.UI.EVENTS.BTN_LOAD_LOCATION = APP.UI.EVENTS.BTN_LOAD_LOCATION || function(){
                    $('#btn_load_location').on('click', function(){
                        if($('#sl_location').val() === '-1'){
                            alert('Select a location first, please.');
                        }else{
                            APP.SERVICES.FETCH_SCALES_DATA($('#sl_location').val());
                        }
                    });
                };

                APP.INIT = APP.INIT || function(){
                    APP.UI.EVENTS.BTN_RELOAD();
                    APP.UI.EVENTS.SP_DATE();
                    APP.UI.EVENTS.SL_LOCATION();
                    APP.UI.EVENTS.BTN_LOAD_LOCATION();
                };

                APP.INIT();
            })(window);
        </script>
    </body>
</html>