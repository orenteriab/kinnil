<!DOCTYPE html>

<html lang="en">

<head>
    <%include ../partials/head %>
        <title>Assets</title>
</head>

<body>

    <%include ../partials/navbar %>

        <div class="wrapper">
            <!-- Sidebar Holder -->
            <%include ../partials/sidebar %>

                <!-- Page Content Holder -->
                <div id="content">
                    <%include ../partials/up %>
                        <ul class="nav nav-tabs">
                            <li role="presentation">
                                <a href="../dispatcher/tobeassigned#">To be Asigned</a>
                            </li>
                            <li role="presentation">
                                <a href="../dispatcher/workinprogress">Work in progress</a>
                            </li>
                            <li role="presentation">
                                <a href="../dispatcher/completed">Completed</a>
                            </li>
                        </ul>
                        <div class="tab-content">
                            <div class="content">

                                <div class="row">
                                    <br/>
                                    <div class="col-md-6">
                                        <p>
                                            <button id="btn_create_asset" href="#dv_csv_load" type="button" class="btn btn-default" aria-label="Left Align" data-toggle="modal" data-target=".manual-input-modal">
                                                Add asset
                                                <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>
                                            </button>
                                        </p>
                                    </div>
                                    <div class="col-md-6">
                                    </div>
                                </div>

                                <div class="row">
                                    <br/>
                                </div>

                                <br/>
                                <div class="row">
                                    <div class="col-md-12">
                                        <table id='grid-basic' border="1" class="table table-bordered table-condensed table-hover table-striped">
                                            <thead>
                                                <tr>
                                                    <th data-column-id="id" data-formatter="link" data-type="numeric">Id</th>
                                                    <th data-column-id="name" data-type="numeric">Name</th>
                                                    <th data-column-id="type">Type</th>
                                                    <th data-column-id="plate">Plate</th>
                                                    <th data-column-id="status" data-formatter="drivers">Status</th>
                                                    <th data-column-id="mi" data-formatter="products">Miles</th>
                                                    <th data-column-id="miLastService" data-formatter="commands" data-sortable="false">Miles of Last Service</th>
                                                </tr>
                                            </thead>
                                            <%if (tickets.length > 0) { %>
                                                <tbody>
                                                    <% for(var i=0; i<tickets.length; i++) {%>
                                                        <%if (tickets[i].status == 1) { %>
                                                            <!-- status:1 = to be asigned -->
                                                            <tr class="quote">
                                                                <td id="">
                                                                    <%= tickets[i].id %>
                                                                </td>
                                                                <td id="">
                                                                    <%= tickets[i].tms %>
                                                                </td>
                                                                <td id="">
                                                                    <%= tickets[i].location %>
                                                                </td>
                                                                <td id="">
                                                                    <%= tickets[i].facility %>
                                                                </td>
                                                                <td id="">

                                                                </td>
                                                                <td id="">

                                                                </td>
                                                                <td id="">
                                                                    <button type="submit" class="btn btn-default"> Assign</button>
                                                                </td>
                                                            </tr>
                                                            <% } %>
                                                                <% } %>
                                                </tbody>
                                                <% } else{ %>
                                                    <tbody>
                                                        <p>No assets in this category</p>
                                                    </tbody>
                                                    <% } %>
                                        </table>
                                    </div>
                                </div>

                            </div>
                        </div>
                </div>
        </div>
        <div id="dv_csv_load" class="modal fade" role="dialog">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <h4>Add new asset</h4>
                    </div>
                    <div class="modal-body">
                        <form id="frm_csv">
                            <label for="tx_name">Name:</label> 
                            <br>
                            <input class="form-control" placeholder="name" name="name" type="text" id="tx_name" />
                            <br>
                            <label for="tx_type">Type:</label>
                            <br>
                            <input class="form-control" placeholder="type" name="type" type="text" id="tx_type" />
                            <br>
                            <label for="tx_plate">Plate:</label>
                            <br>
                            <input class="form-control" placeholder="plate" name="plate" type="text" id="tx_plate" />
                            <br>
                            <label for="tx_status">Status:</label>
                            <br>
                            <input class="form-control" placeholder="status" name="status" type="text" id="tx_status" />
                            <br>
                            <label for="tx_mi">Miles:</label>
                            <br>
                            <input class="form-control" placeholder="mi" name="mi" type="number" id="tx_mi" />
                            <br>
                            <label for="tx_miLastService">Miles of last service:</label>
                            <br>
                            <input class="form-control" placeholder="miLastService" name="miLastService" type="number" id="tx_miLastService" />
                            <br>
                            <label for="tx_mttoLast">Mtto. Last:</label>
                            <br>
                            <input class="form-control" placeholder="mttoLast" name="mttoLast" type="date" id="tx_mttoLast" />
                            <br>
                            <label for="tx_mttoNext">Mtto. Next:</label>
                            <br>
                            <input class="form-control" placeholder="mttoNext" name="mttoNext" type="date" id="tx_mttoNext" />
                            <br>
                            <label for="tx_notes">Notes:</label>
                            <br>
                            <input class="form-control" placeholder="notes" name="notes" type="text" id="tx_notes" />
                            <br>
                            <label for="tx_up">Up:</label>
                            <br>
                            <input class="form-control" placeholder="up" name="up" type="number" id="tx_up" />
                            <br>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button id="btn_save_asset" type="button" class="btn btn-primary">Save asset</button>
                        <button id="btn_cancel_asset" type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- <script src="/socket.io/socket.io.js"></script>  -->
        <%include ../partials/js %>

            <!-- Ticket detail modal  -->
            <%include ../partials/ticket-detail %>


                <!--
        Inicializa el bootgrid y sus opciones, TODO: ver si se puede alimentar esto desde un endpoint
    -->
                <script type="text/javascript">
                    (function (APP) {
                        APP.SERVICE = APP.SERVICE || {};

                        APP.SERVICE.ASSETS = APP.SERVICE.ASSETS || {};
                        APP.SERVICE.ASSETS.CREATE = APP.SERVICE.ASSETS.CREATE || function(){
                            $('#frm_csv').attr('disabled', 'disabled');

                            var postData = {
                                name: $("#tx_name").val(),
                                type: $("#tx_type").val(),
                                plate: $("#tx_plate").val(),
                                status: $("#tx_status").val(),
                                mi: $("#tx_mi").val(),
                                miLastService: $("#tx_miLastService").val(),
                                mttoLast: $("#tx_mttoLast").val(),
                                mttoNext: $("#tx_mttoNext").val(),
                                notes: $("#tx_notes").val(),
                                up: $("#tx_up").val()
                            };
                            
                            $.ajax({
                                url: '/api/assets/create',
                                method: 'POST',
                                data: postData,
                                success: function(data){
                                    alert(data.message);
                                    document.getElementById('frm_csv').reset();
                                    $('#frm_csv').removeAttr('disabled');
                                    $('#dv_csv_load').modal('toggle');
                                }
                            });
                        };

                        APP.SERVICE.DISPATCHER = APP.SERVICE.DISPATCHER || {};

                        APP.SERVICE.DISPATCHER.GET_UPS = APP.SERVICE.DISPATCHER.GET_UPS || function () {
                            $.ajax({
                                cache: false,
                                method: 'GET',
                                url: '/api/dispatcher/getUps',
                                success: function (data) {
                                    $('#trailersUp').html(data.trailersUp);
                                    $('#trucksUp').html(data.trucksUp);
                                    $('#driversUp').html(data.driversUp);
                                },
                                error: function (e) {
                                    console.error(e);
                                    alert('Couldn\'t load data for trailers up, drivers up, and trucks up.');
                                }
                            });
                        };

                        APP.SERVICE.DISPATCHER.ASSIGN_TICKET = APP.SERVICE.DISPATCHER.ASSIGN_TICKET || function () {
                            $.ajax({
                                cache: false,
                                url: '/api/dispatcher/assignTicket/',
                                type: 'PUT',
                                data: {
                                    ticketId: $(this).data("row-id"), // undefined
                                    hrId: $("#driverSelect").val(),
                                    product: $("#productsSelect").val()
                                },
                                success: function (msj) {
                                    alert(msj.message);
                                    location.reload();
                                },
                                error: function (xhr) {
                                    alert('Couldn\'t assign ticket. Try again, please.');
                                },
                            });
                        };

                        APP.SERVICE.DISPATCHER.GET_TICKET_DETAIL = APP.SERVICE.DISPATCHER.GET_TICKET_DETAIL || function (ticketId) {
                            var url = "/api/dispatcher/getTicketDetail/" + ticketId;
                            $.ajax({
                                cache: false,
                                method: 'GET',
                                url: url,
                                dataType: 'application/json',
                                success: function (data) {
                                    $('#trailersUp').html(data.trailersUp);
                                    $('#trucksUp').html(data.trucksUp);
                                    $('#driversUp').html(data.driversUp);
                                },
                                error: function (err) {
                                    console.error(err);
                                    alert('Couldn\'t load data for ticket ' + ticketId);
                                }
                            });
                        };

                        APP.SERVICE.TICKETS = {};

                        APP.SERVICE.TICKETS.UPLOAD_CSV = APP.SERVICE.TICKETS.UPLOAD_CSV || function (csvArray) {
                            var ajaxRequests = [];
                            for (var i = 0; i < csvArray.length; i++) {
                                ajaxRequests.push(
                                    $.ajax({
                                        method: 'POST',
                                        url: '/api/tickets/upload/csv',
                                        dataType: 'json',
                                        data: {
                                            record: csvArray[i]
                                        },
                                        success: function (data) {
                                            console.log(data);
                                        },
                                        error: function (e, d, f) {
                                            console.error(e);
                                            console.error(f);
                                        }
                                    })
                                );
                            }
                            $.when
                                .apply(undefined, ajaxRequests).always(function () {
                                    var failed = [];

                                    for (var i = 0; i < ajaxRequests.length; i++) {
                                        var requestStatus = parseInt(ajaxRequests[i].status);
                                        if (requestStatus < 200 || requestStatus > 299) {
                                            failed.push(ajaxRequests[i].responseText);
                                        }
                                    }

                                    if (failed.length > 0) {
                                        alert("Some records couldn't be saved:\n" + failed.join(" | "));
                                    } else {
                                        alert("All records were saved successfully!");
                                    }

                                    APP.location.reload();
                                });
                        }

                        APP.LOAD = APP.LOAD || {};

                        //page load functionality first!
                        APP.LOAD.SIDE_BAR = APP.LOAD.SIDE_BAR || function () {
                            $('#sidebarCollapse').on('click', function () {
                                $('#sidebar').toggleClass('active');
                            });
                        };

                        //Obtiene los drivers, trucks and trailers que estan disponibles
                        APP.LOAD.UPS = APP.LOAD.UPS || function () {
                            APP.SERVICE.DISPATCHER.GET_UPS();
                        };

                        APP.LOAD.GRID = APP.LOAD.GRID || function () {
                            var linkFormatter = function (column, row) {
                                return "<a href=\"#myModal\" data-toggle=\"modal\" data-ticket=\"" + row.id + "\" class=\"text-center black-link show-ticket\">" + row.id + "</a>";
                            };

                            var commandsFormatter = function (column, row) {
                                return "<button type=\"button\" class=\"btn btn-md btn-default command-edit\" data-row-id=\"" + row.id + "\">Assign</button> "
                            };

                            var driversFormatter = function (colum, row) {
                                return "<%if (drivers.length > 0) { %> " +
                                    "<div class='form-group'> " +
                                    "<select class='form-control' id='driverSelect" + row.id + "'>" +
                                    "<% for(var x=0; x<drivers.length; x++) {%>" +
                                    "<option value = '<%= drivers[x].id %>'><%= drivers[x].name %></option> " +
                                    "<% } %>" +
                                    "</select>" +
                                    "</div>" +
                                    "<% } else{ %> " +
                                    "No drivers available" +
                                    "<% } %>";
                            };

                            var productsFormatter = function (colum, row) {
                                return "<%if (products.length > 0) { %> " +
                                    "<div class='form-group'> " +
                                    "<select class='form-control' id='productsSelect" + row.id + "'>" +
                                    "<% for(var x=0; x<products.length; x++) {%>" +
                                    "<option value = '<%= products[x].id %>'><%= products[x].name %></option> " +
                                    "<% } %>" +
                                    "</select>" +
                                    "</div>" +
                                    "<% } else{ %> " +
                                    "No products available" +
                                    "<% } %>";
                            };

                            var loadedRsJQueryBootgrid = function () {
                                /* Executes after data is loaded and rendered */
                                var onClickEdit = function (e) {
                                    //APP.SERVICE.DISPATCHER.ASSIGN_TICKET(this);

                                    $.ajax({
                                        url: '/api/dispatcher/assignTicket/',    //Your api url
                                        type: 'PUT',   //type is any HTTP method
                                        data: {
                                            ticketId: $(this).data("row-id"),
                                            //hrId: $(this).data("row-driver").value(),
                                            //product: $(this).data("row-product").value(),
                                            hrId: $("#driverSelect" + $(this).data("row-id")).val(),
                                            product: $("#productsSelect" + $(this).data("row-id")).val()

                                        },      //Data as js object
                                        success: function (msj) {
                                            alert(msj.message);
                                            location.reload();
                                        },
                                        error: function (xhr) { // if error occured
                                            alert("Error occured. please try again");
                                        },
                                    });
                                };

                                var onClickShow = function (e) {
                                    $($(this).attr("href")).modal("show", $(this));
                                };

                                $("#grid-basic")
                                    .find(".command-edit")
                                    .on("click", onClickEdit)
                                    .end()
                                    .find(".show-ticket")
                                    .on("click", onClickShow);
                            };

                            $("#grid-basic")
                                .bootgrid({
                                    labels: {
                                        search: "Search (TMS, Ticket, etc)"
                                    },
                                    formatters: {
                                        "link": linkFormatter,
                                        "commands": commandsFormatter,
                                        "drivers": driversFormatter,
                                        "products": productsFormatter
                                    }
                                })
                                .on("loaded.rs.jquery.bootgrid", loadedRsJQueryBootgrid);
                        };

                        APP.EVENTS = APP.EVENTS || {
                            PINCHE_BOTON: function () {
                                var infoModal = $('#ticketModal');
                                $('#PincheBoton').on('click', function () {
                                    APP.SERVICE.DISPATCHER.GET_TICKET_DETAIL(8);
                                });
                            },
                            FRM_CSV: function () {
                                $('#frm_csv').on('submit', function (evt) {
                                    evt.preventDefault();
                                    return false;
                                });
                            },
                            FL_CSV: function () {
                                $('label').on('click', function (evt) {
                                    if ($(this).attr('disabled') == 'disabled') {
                                        evt.preventDefault();
                                        return false;
                                    }
                                });

                                $('#fl_csv').on('change', function () {
                                    var filename = $(this).val();

                                    if (confirm('Are you sure you want to upload the file ' + filename + '?')) {
                                        $('#sp_fl_csv')
                                            .parent()
                                            .attr('disabled', 'disabled');

                                        $('#sp_fl_csv')
                                            .text('Uploading file...');

                                        var fileReader = new FileReader();

                                        fileReader.onerror = function (err) {
                                            alert('Error when loading file. Please try again.');
                                            $('#sp_fl_csv')
                                                .parent()
                                                .removeAttr('disabled');

                                            $('#sp_fl_csv')
                                                .text('Search file');
                                        };

                                        fileReader.onload = function (evt) {
                                            var jsonObjects = $.csv.toObjects(evt.target.result);
                                            APP.SERVICE.TICKETS.UPLOAD_CSV(jsonObjects);
                                        };

                                        fileReader.readAsText($('#fl_csv')[0].files[0]);
                                    }

                                });
                            },
                            BTN_CREATE_ASSET: function(){
                                $('#btn_create_asset').on('click', function(){
                                    var modalToOpen = $(this).attr('href');
                                    $(modalToOpen).modal('show', $(this));
                                });
                            },
                            BTN_CANCEL_ASSET: function(){
                                $('#btn_cancel_asset').on('click', function(){
                                    document.getElementById('frm_csv').reset();
                                });
                            },
                            BTN_SAVE_ASSET: function(){
                                $('#btn_save_asset').on('click', function(){
                                    APP.SERVICE.ASSETS.CREATE();
                                });
                            },
                            INIT: function () {
                                APP.EVENTS.PINCHE_BOTON();
                                APP.EVENTS.FRM_CSV();
                                APP.EVENTS.FL_CSV();
                                APP.EVENTS.BTN_CREATE_ASSET();
                                APP.EVENTS.BTN_CANCEL_ASSET();
                                APP.EVENTS.BTN_SAVE_ASSET();
                                $('li.active').removeClass('active');
                                $('#AssetsSubmenu').parent().attr('class', 'active');
                            }
                        };

                        APP.LOAD.SIDE_BAR();
                        APP.LOAD.UPS();
                        APP.LOAD.GRID();
                        APP.EVENTS.INIT();
                    })(window);
                </script>

</body>

</html>