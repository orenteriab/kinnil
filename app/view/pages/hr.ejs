<!DOCTYPE html>

<html lang="en">
<head>
   <%include ../partials/head %>
   <title>Human Resources</title>
</head>

<body>

<%include ../partials/navbar %>

<div class="wrapper">
        <!-- Sidebar Holder -->
        <%include ../partials/sidebar %>

        <!-- Page Content Holder -->
        <div id="content" class="main-content">
            <ul class="nav nav-tabs">
                    <li role="presentation"><a href="../administrative/clients">Clients</a></li>
                    <li role="presentation" class="active"><a href="../administrative/hr">Human resources</a></li>
                    <li role="presentation"><a href="../administrative/drivers">Drivers</a></li>
                    <li role="presentation"><a href="../administrative/clockin">Clockin</a></li>
            </ul>
            <div class="tab-content"> 
                <div class="content">
                    <br>
                    <div class="row">
                        <div class="col-md-12">
                            <h4>Employees</h4>
                            <button type="button" class="btn btn-secondary" data-toggle="modal" data-target="#addHrModal">Add employee</button>
                            <table id='grid-basic' border="1" class="table table-bordered table-condensed table-hover table-striped" >
                                <thead>
                                    <tr>
                                        <th data-column-id="id" data-type="numeric">#</th>
                                        <th data-column-id="name" data-formatter="link">Name</th>
                                        <th data-column-id="tel">Phone</th>
                                        <th data-column-id="position">Position</th>
                                        <th data-column-id="laborstatus" data-formatter="laborstatus">Labor Status</th>
                                    </tr>
                                </thead>
                                <%if (hr.length > 0) { %>
                                <tbody>
                                    <% for(var i=0; i<hr.length; i++) {%>
                                        <tr class="quote">
                                            <td id=""> <%= hr[i].id %> </td>
                                            <td id=""> <%= hr[i].name || 'Name not available' %> </td>
                                            <td id=""> <%= hr[i].tel || 'Phone not available' %> </td>
                                            <td id=""> <%= hr[i].position || 'Position not available' %> </td>
                                            <td id=""> <%= hr[i].labor_status || 'Status not available' %> </td>
                                        </tr>
                                    <% } %>
                                </tbody>
                                <% } else{ %>  
                                    <tbody>
                                        <p>No hr</p>
                                    </tbody>
                                <% } %>
                            </table>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

<!-- Add HR -->
<div class="modal fade" id="addHrModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h4 class="modal-title" id="myModalLabel">Add Employee</h4>
        </div>
        <form role="form" id="addHrForm">
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <label for="name" class="h4 ">Name</label>
                        <input id="name" class="form-control" required></input>
                        <label for="address" class="h4 ">Address</label>
                        <input id="address" class="form-control" required></input>
                        <label for="tel" class="h4 ">Phone</label>
                        <input id="tel" class="form-control" required type="tel"></input>
                        <label for="birth" class="h4 ">Date of birth</label>
                        <input id="birth" class="form-control" required type="date"></input>
                        <label for="civilStatus" class="h4 ">Civil status</label>
                        <select id="civilStatus" class="form-control">
                            <option value="SINGLE">Single</option>
                            <option value="MARRIED">Married</option>
                            <option value="DIVORCED">Divorced</option>
                            <option value="SEPARATED">Separated</option>
                            <option value="WIDOWED">Widowed</option>
                        </select>
                        <label for="email" class="h4 ">email</label>
                        <input id="email" class="form-control" required type="email"></input>
                        <label for="laborStatus" class="h4 ">Labor status</label>
                        <select id="laborStatus" class="form-control">
                            <option value="WORKING WITH US">Working with us</option>
                            <option value="NOT WORKING WITH US">Not Working with us</option>
                        </select>
                        <label for="position" class="h4 ">Position</label>
                        <select id="position" class="form-control">
                            <option value="FIELD CREW SUPERVISOR">Field Crew Supervisor</option>
                            <option value="FIELD CREW MANAGER">Field Crew Manager</option>
                            <option value="FIELD CREW OPERATOR">Field Crew Operator</option>
                            <option value="OPERATIONS">Operation</option>
                            <option value="MECHANICS">Mechanics</option>
                            <option value="OFFICE">Office</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="crew" class="h4">Crew</label>
                        <select id="crew" class="form-control">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                        </select>
                        <label for="shift" class="h4">Shift</label>
                        <select id="shift" class="form-control">
                            <option value="AM">am</option>
                            <option value="PM">pm</option>
                        </select>
                        <label for="username" class="h4 ">username</label>
                        <input id="username" class="form-control" required></input>
                        <label for="password" class="h4 ">Password</label>
                        <input id="password" class="form-control" required></input>
                        <label for="dllsHr" class="h4 ">Dlls/hr</label>
                        <input id="dllsHr" class="form-control" step='0.01' value='0.00' required type="number"></input>
                        <label for="mcExp" class="h4 ">Medical card expiration date</label>
                        <input id="mcExp" class="form-control" required type="date"></input>
                        <label for="ssn" class="h4 ">SSN</label>
                        <input id="ssn" class="form-control" required></input>
                        <label for="contact1" class="h4 ">Emergency contact Name</label>
                        <input id="contact1" class="form-control"></input>
                        <label for="contact2" class="h4 ">Emergency contact Phone</label>
                        <input id="contact2" class="form-control" type="tel"></input>
                    </div>
                    
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="submit" class="btn btn-secondary">Save changes</button>
            </div>
        </form>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->




<!-- HR Detail -->
<div class="modal fade" id="editHrModal" role="dialog">
    <div class="modal-dialog modal-lg">

        <!-- Modal content-->
        <div class="modal-content">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal">&times;</button>
            <h4>Employee Details</h4>
        </div>
        <div class="modal-body">
        <div id="to-print">
            <div class="row">
                <div class="col-md-6">
                    <p>Name <span id="editName"> </span></p>
                    <p>Address <span id="editAddress"> </span></p>
                    <p>Phone <span id="editTel"> </span></p>
                    <p>Date of birth <span id="editBrith"> </span></p>
                    <p>Civil status <span id="editCivilStatus"> </span></p>
                    <p>email <span id="editEmail"> </span></p>
                    <p>Emergency contact Name <span id="editContact1"> </span></p>
                    <p>Emergency contact Phone <span id="editContact2"> </span></p>
                </div>
                <div class="col-md-6">
                    <p>Crew <span id="editCrew"> </span></p>
                    <p>Shift <span id="editShift"> </span></p>
                    <p>Labor status <span id="editLaborStatus"> </span></p>
                    <p>Position <span id="editPosition"> </span></p>
                    <p>Username <span id="editUsername"> </span></p>
                    <p>Password <span id="editPassword"> </span></p>
                    <p>Dlls/hr <span id="editDllsHr"> </span></p>
                    <p>Medical card expiration date <span id="editMcExp"> </span></p>
                    <p>SSN <span id="editSsn"> </span></p>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            <button id="hr-to-pdf" type="button" class="btn btn-success" >Download</button>
        </div>
        </div>
    </div>
</div> 

    <!-- <script src="/socket.io/socket.io.js"></script>  -->
    <%include ../partials/js %>


    <!--
        Inicializa el bootgrid y sus opciones, TODO: ver si se puede alimentar esto desde un endpoint
    -->
    <script>
        (function(APP){
            APP.SERVICE = APP.SERVICE || {};

            APP.SERVICE.ADMINISTRATIVE = APP.SERVICE.ADMINISTRATIVE || {};

            APP.LOAD = APP.LOAD || {};

            //page load functionality first!
            APP.LOAD.SIDE_BAR = APP.LOAD.SIDE_BAR || function () {
                $('#sidebarCollapse').on('click', function () {
                    $('#sidebar').toggleClass('active');
                });
            };
            
            APP.LOAD.GRID = APP.LOAD.GRID || function(){

                var linkFormatter = function(column, row){
                    return "<a href=\"#editHrModal\" data-toggle=\"modal\" data-hr=\"" + row.id +  "\" class=\"text-center black-link show-edit-hr\">" + row.name + "</a>";
                };

                var loadedRsJQueryBootgrid = function(){

                    var onEditHrShow = function(e){
                        $($(this).attr("href")).modal("show", $(this));
                    };

                    $("#grid-basic")
                        .find(".show-edit-hr")
                        .on("click", onEditHrShow);
                };

                $("#grid-basic")
                    .bootgrid({
                        caseSensitive: false,
                        rowCount: [50,75,100,-1],
                        formatters: {
                            "link": linkFormatter
                        }
                    })
                    .on("loaded.rs.jquery.bootgrid", loadedRsJQueryBootgrid);
            };

            APP.EVENTS = APP.EVENTS || {
                MODALS_SUBMIT: function(){

                    // Add HR
                    $("#addHrForm").submit(function(event) {

                        event.preventDefault(); // cancels the form submission
                        $.ajax({
                            cache: false,
                            url: '/api/administrative/addhr/',
                            type: 'POST',
                            data: {
                                name: $("#name").val(),
                                address: $("#address").val(),
                                tel: $("#tel").val(),
                                civilStatus: $("#civilStatus").val(),
                                email: $("#email").val(),
                                contact1: $("#contact1").val(),
                                contact2: $("#contact2").val(),
                                username: $("#username").val(),
                                password: $("#password").val(),
                                birth: $("#birth").val(),
                                laborStatus: $("#laborStatus").val(),
                                position: $("#position").val(),
                                dllsHr: $("#dllsHr").val(),
                                mcExp: $("#mcExp").val(),
                                ssn: $("#ssn").val(),
                                shift: $("#shift").val(),
                                crew: $("#crew").val()
                            },
                            success: function (msj) {
                                alert(msj.message);
                                location.reload(); // Recarga la pagina para ver el cambio
                            },
                            error: function(xhr) {
                                alert('Couldn\'t insert in the database. Try again, please.');
                            },
                        });

                        $('#addSandModal').modal('hide');
                    });
                },
                INIT: function(){
                    APP.EVENTS.MODALS_SUBMIT();
                }
            };
            
            APP.LOAD.SIDE_BAR();
            APP.LOAD.GRID();
            APP.EVENTS.INIT();
        })(window);
    </script>

    <script>
        $( document ).ready(function() {
            $('#editHrModal').on('shown.bs.modal', function (e) {

                var $trigger = $(e.relatedTarget);
                
                // Obtiene el detalle del ticket
                $.getJSON('/api/administrative/getHrDetail/' + $trigger.data('hr'), function(data) {
    

                    $('#editName').html(
                        "<strong><a id='updateName' data-pk='" + data.hr[0].id + "' data-title='Update name' "+
                        "data-type='text' class='black-link' "+
                        "href='#' data-name='name'>"+data.hr[0].name+"</a></strong>"    
                    );
                    $('#editAddress').html(
                        "<strong><a id='updateAddress' data-pk='" + data.hr[0].id + "' data-title='Update address' "+
                        "data-type='text' class='black-link' "+
                        "href='#' data-name='address'>"+data.hr[0].address+"</a></strong>"
                    );
                    $('#editTel').html(
                        "<strong><a id='updateTel' data-pk='" + data.hr[0].id + "' data-title='Update tel' "+
                        "data-type='text' class='black-link' "+
                        "href='#' data-name='tel'>"+data.hr[0].tel+"</a></strong>"
                    );
                    $('#editUsername').html(
                        "<strong><a id='updateUsername' data-pk='" + data.hr[0].id + "' data-title='Update username' "+
                        "data-type='text' class='black-link' "+
                        "href='#' data-name='username'>"+data.hr[0].username+"</a></strong>"    
                    );
                    $('#editPassword').html(
                        "<strong><a id='updatePassword' data-pk='" + data.hr[0].id + "' data-title='Update password' "+
                        "data-type='text' class='black-link' "+
                        "href='#' data-name='password'>"+data.hr[0].password+"</a></strong>"    
                    );
                    $('#editCivilStatus').html(
                        "<strong><a id='updateCivilStatus' data-pk='" + data.hr[0].id + "' data-title='Update civil status' "+
                        "data-type='select' class='black-link' "+
                        "href='#' data-name='civil_status'>"+data.hr[0].civil_status+"</a></strong>"
                    );
                    $('#editEmail').html(
                        "<strong><a id='updateEmail' data-pk='" + data.hr[0].id + "' data-title='Update email' "+
                        "data-type='email' class='black-link' "+
                        "href='#' data-name='email'>"+data.hr[0].email+"</a></strong>"
                    );
                    $('#editContact1').html(
                        "<strong><a id='updateContact1' data-pk='" + data.hr[0].id + "' data-title='Update contact 1' "+
                        "data-type='text' class='black-link' "+
                        "href='#' data-name='contact1'>"+data.hr[0].contact1+"</a></strong>"
                    );
                    $('#editContact2').html(
                        "<strong><a id='updateContact2' data-pk='" + data.hr[0].id + "' data-title='Update contact2' "+
                        "data-type='text' class='black-link' "+
                        "href='#' data-name='contact2'>"+data.hr[0].contact2+"</a></strong>"
                    );
                    $('#editBrith').html(
                        "<strong><a id='updateBrith' data-type='combodate' data-format='YYYY-MM-DD' data-viewformat='MM-DD-YYYY' data-pk='" + data.hr[0].id + "' data-title='Update birthdate' "+
                        "data-type='date' class='black-link' "+
                        "href='#' data-name='birthdate'>"+data.hr[0].birthdate+"</a></strong>"
                    );
                    $('#editLaborStatus').html(
                        "<strong><a id='updateLaborStatus' data-pk='" + data.hr[0].id + "' data-title='Update labor status' "+
                        "data-type='select' class='black-link' "+
                        "href='#' data-name='labor_status'>"+data.hr[0].labor_status+"</a></strong>"
                    );
                    $('#editPosition').html(
                        "<strong><a id='updatePosition' data-pk='" + data.hr[0].id + "' data-title='Update position' "+
                        "data-type='select' class='black-link' "+
                        "href='#' data-name='position'>"+data.hr[0].position+"</a></strong>"
                    );
                    $('#editDllsHr').html(
                        "<strong><a id='updateDllsHr' data-pk='" + data.hr[0].id + "' data-title='Update dlls/hr' "+
                        "type='number' step='0.01' value='0.00' class='black-link' "+
                        "href='#' data-name='dll_hr'>"+data.hr[0].dll_hr+"</a></strong>"
                    );
                    $('#editMcExp').html(
                        "<strong><a id='updateMcExp' data-type='combodate' data-format='YYYY-MM-DD' data-viewformat='MM-DD-YYYY' data-pk='" + data.hr[0].id + "' data-title='Update medical card expiration date' "+
                        "data-type='date' class='black-link' "+
                        "href='#' data-name='mc_exp'>"+data.hr[0].mc_exp+"</a></strong>"
                    );
                    $('#editSsn').html(
                        "<strong><a id='updateSsn' data-pk='" + data.hr[0].id + "' data-title='Update ssn' "+
                        "data-type='text' class='black-link' "+
                        "href='#' data-name='ssn'>"+data.hr[0].ssn+"</a></strong>"
                    );
                    $('#editCrew').html(
                        "<strong><a id='updateCrew' data-pk='" + data.hr[0].id + "' data-title='Update crew' "+
                        "data-type='select' class='black-link' "+
                        "href='#' data-name='crew'>"+data.hr[0].crew+"</a></strong>"
                    );
                    $('#editShift').html(
                        "<strong><a id='updateShift' data-pk='" + data.hr[0].id + "' data-title='Update shift' "+
                        "data-type='select' class='black-link' "+
                        "href='#' data-name='shift'>"+data.hr[0].shift+"</a></strong>"
                    );
    
                    // x-editable
                    $('#updateName, #updateAddress, #updateTel, #updateUsername, #updatePassword, #updateEmail, #updateContact1, #updateContact2, #updateDllsHr, #updateSsn').editable({
                        url: '/api/administrative/updatehr/',
                        send: 'always',
                        success: function(response, newValue) {
                            if (response.status == 'error') 
                                return response.msg; //msg will be shown in editable form
                        }
                        
                    });

                    $('#updateDllsHr').editable({
                        url: '/api/administrative/updatehr/',
                        send: 'always',
                        type : 'number',
                        step: 'any',
                        success: function(response, newValue) {
                            if (response.status == 'error') 
                                return response.msg; //msg will be shown in editable form
                        }
                    });

                    $('#updateCivilStatus').editable({   
                        url: '/api/administrative/updatehr/',
                        send: 'always',
                        source: [
                            {value: "SINGLE", text: 'Single'},
                            {value: "MARRIED", text: 'Maried'},
                            {value: "DIVORCED", text: 'Divorced'},
                            {value: "SEPARATED", text: 'Separated'},
                            {value: "WIDOWED", text: 'Widowed'}
                        ],
                        success: function(response, newValue) {
                            if (response.status == 'error') 
                                return response.msg; //msg will be shown in editable form
                        },
                    });

                    $('#updateBrith, #updateMcExp').editable({
                        url: '/api/administrative/updatehr/',
                        send: 'always',
                        format: 'yyyy-mm-dd',    
                        viewformat: 'mm-dd-yyyy',
                        combodate: { 
                            maxYear: 2025,
                            minYear:1930
                         }, 
                        datepicker: {
                                weekStart: 1
                        },
                        success: function(response, newValue) {
                            if (response.status == 'error') 
                                return response.msg; //msg will be shown in editable form
                        },
                    });

                    $('#updateLaborStatus').editable({   
                        url: '/api/administrative/updatehr/',
                        send: 'always',
                        source: [
                            {value: "WORKING WITH US", text: 'Working with us'},
                            {value: "NOT WORKING WITH US", text: 'Not working with us'}
                        ],
                        success: function(response, newValue) {
                            if (response.status == 'error') 
                                return response.msg; //msg will be shown in editable form
                        },
                    });

                    $('#updatePosition').editable({   
                        url: '/api/administrative/updatehr/',
                        send: 'always',
                        source: [
                            {value: "FIELD CREW SUPERVISOR", text: 'Field crew supervisor'},
                            {value: "FIELD CREW MANAGER", text: 'Field crew manager'},
                            {value: "FIELD CREW OPERATOR", text: 'Field crew operator'},
                            {value: "OPERATIONS", text: 'Operations'},
                            {value: "MECHANICS", text: 'Mechanic'},
                            {value: "OFFICE", text: 'Office'}
                        ],
                        success: function(response, newValue) {
                            if (response.status == 'error') 
                                return response.msg; //msg will be shown in editable form
                        },
                    });

                    $('#updateCrew').editable({   
                        url: '/api/administrative/updatehr/',
                        send: 'always',
                        source: [
                            {value: "1", text: '1'},
                            {value: "2", text: '2'},
                            {value: "3", text: '3'},
                            {value: "4", text: '4'},
                            {value: "5", text: '5'},
                            {value: "6", text: '6'},
                            {value: "7", text: '7'},
                            {value: "8", text: '8'},
                            {value: "9", text: '9'},
                            {value: "10", text: '10'}
                        ],
                        success: function(response, newValue) {
                            if (response.status == 'error') 
                                return response.msg; //msg will be shown in editable form
                        },
                    });

                    $('#updateShift').editable({   
                        url: '/api/administrative/updatehr/',
                        send: 'always',
                        source: [
                            {value: "AM", text: 'am'},
                            {value: "PM", text: 'pm'}
                        ],
                        success: function(response, newValue) {
                            if (response.status == 'error') 
                                return response.msg; //msg will be shown in editable form
                        },
                    });
                });

            })
            
            // Recarga la pagina para que se vean los cambios
            $('#editHrModal').on('hide.bs.modal', function (e) {
                location.reload();
            });

            $('#hr-to-pdf').on('click', function(){
                /*
                * Por las prisas se genera este PDF con addHTML. Hay que ver si no la hacen de pedo por la calidad de la imagen
                * Aqui esta un ejemplo que hay que estudiar, parece que tiene todo lo que necesitamos https://codepen.io/LittleViolette/pen/begBbe
                */
                var pdf = new jsPDF('p', 'pt', 'letter');

                var options = {
                    pagesplit: true,
                    background: '#ffffff',
                    pagesplit: true
                }

                var nombre = $('#editName').text()
                
                pdf.addHTML($('#to-print')[0], 40, 40, options, function () {
                    pdf.save(nombre + '.pdf');
                });
            });
        });

        $('li[id="li_sdbr_administrative"]').addClass('active');
        
        </script>


</body>
</html>
